<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pac-like Mobile Game</title>
  <style>
    :root{
      --bg: #07102b;
      --panel: rgba(255,255,255,0.06);
      --accent: #ffcc00;
      --muted: rgba(255,255,255,0.8);
      --control-size: 44px; /* Smaller for better fit */
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    #game-root{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      padding: env(safe-area-inset);
      box-sizing:border-box;
    }

    /* Canvas takes more space now */
    #game-canvas{
      background: linear-gradient(180deg,#05102b,#07132f);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      max-width: 95%; /* Slightly more room */
      max-height: 95%;
      display:block;
    }

    /* Touch controls - now bottom-center for better fit */
    #touch-controls{
      position: absolute;
      left:50%;
      bottom:12px;
      transform: translateX(-50%);
      display:grid;
      grid-template-columns: var(--control-size) var(--control-size);
      gap:6px; /* Tighter gap */
      z-index:10;
      user-select:none;
      touch-action:none;
      opacity: 0.9; /* Subtler */
      transition: opacity 0.3s;
    }

    #touch-controls:hover,
    #touch-controls:active { opacity: 1; }

    #touch-controls .dir{
      width:var(--control-size);
      height:var(--control-size);
      border-radius:10px; /* Slightly smaller radius */
      border:none;
      background:var(--panel);
      color:var(--accent);
      font-weight:800;
      font-size:18px; /* Smaller text */
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-user-select:none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4); /* Softer shadow */
    }

    /* Full controller mode (A/B/L/R buttons) */
    #full-controls{
      position: absolute;
      right:12px;
      bottom:12px;
      display: none; /* Hidden by default */
      flex-direction: column;
      gap: 8px;
      z-index:10;
    }

    .action-btn{
      width: var(--control-size);
      height: var(--control-size);
      border-radius: 50%; /* Round like console buttons */
      border: none;
      background: var(--accent);
      color: #111;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }

    /* Top-right overlay */
    #overlay{
      position:absolute;
      right:12px;
      top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:10;
      align-items:flex-end;
    }

    #start-btn, #toggle-controls{
      padding:8px 12px;
      border-radius:10px;
      border:none;
      background:var(--accent);
      color:#111;
      font-weight:800;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    #status{
      font-size:13px;
      opacity:0.95;
      text-align:right;
      color:var(--muted);
    }

    /* Small credit/footer */
    #credit{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:8px;
      font-size:12px;
      color:rgba(255,255,255,0.6);
      z-index:5;
    }

    /* Even smaller on tiny screens or landscape */
    @media (max-width:420px) or (orientation: landscape){
      :root { --control-size: 36px; }
      #touch-controls { gap:4px; }
      #full-controls { gap:6px; }
      #game-canvas { max-width: 98%; max-height: 98%; }
    }
  </style>
</head>
<body>
  <div id="game-root">
    <canvas id="game-canvas" aria-label="Game canvas"></canvas>

    <!-- D-pad controls (bottom-center now) -->
    <div id="touch-controls">
      <button class="dir up" data-dir="up" aria-label="Up">▲</button>
      <button class="dir left" data-dir="left" aria-label="Left">◀</button>
      <button class="dir right" data-dir="right" aria-label="Right">▶</button>
      <button class="dir down" data-dir="down" aria-label="Down">▼</button>
    </div>

    <!-- Full controller extras (A/B for actions, L/R shortcuts) -->
    <div id="full-controls">
      <button class="action-btn" id="l-btn">L</button>
      <button class="action-btn" id="r-btn">R</button>
      <button class="action-btn" id="a-btn">A</button>
      <button class="action-btn" id="b-btn">B</button>
    </div>

    <div id="overlay">
      <button id="toggle-controls">Full Ctrl</button>
      <button id="start-btn">Start</button>
      <div id="status">Tap Start to play! Swipe or use buttons.</div>
    </div>

    <div id="credit">Pac-like demo • Better mobile fit • Touch/swipe/keyboard</div>
  </div>

  <script>
    /* Inline JS - Updated for better control fit */

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');

    // Virtual grid (tile-based)
    const COLS = 19;
    const ROWS = 21;
    const TILE = 16;
    const VIRTUAL_W = COLS * TILE;
    const VIRTUAL_H = ROWS * TILE;

    // Generate simple map
    const map = new Array(ROWS).fill(0).map((_, r) => {
      return new Array(COLS).fill(0).map((_, c) => {
        if (r === 0 || r === ROWS - 1 || c === 0 || c === COLS - 1) return 1; // wall
        if ((r % 4 === 0) && (c % 4 === 0)) return 1;
        return 2; // pellet
      });
    });

    // Player
    const player = {
      x: TILE * 1.5,
      y: TILE * 1.5,
      radius: TILE * 0.45,
      dir: null,
      nextDir: null,
      speed: 80,
    };

    // Game state
    let gameRunning = false;
    let score = 0;

    // Canvas resize (improved for landscape/mobile)
    function resizeCanvas() {
      const scale = Math.min((window.innerWidth * 0.95) / VIRTUAL_W, (window.innerHeight * 0.95) / VIRTUAL_H);
      const displayW = Math.floor(VIRTUAL_W * scale);
      const displayH = Math.floor(VIRTUAL_H * scale);
      const dpr = Math.max(1, window.devicePixelRatio || 1);

      canvas.style.width = displayW + 'px';
      canvas.style.height = displayH + 'px';
      canvas.width = Math.floor(displayW * dpr);
      canvas.height = Math.floor(displayH * dpr);

      ctx.setTransform(dpr * scale, 0, 0, dpr * scale, 0, 0);
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));
    resizeCanvas();

    // Input handling (same as before, but added action buttons)
    const keys = {};
    window.addEventListener('keydown', e => {
      const mapKey = {ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right', w:'up', a:'left', s:'down', d:'right'}[e.key];
      if (mapKey) { keys[mapKey] = true; e.preventDefault(); }
      if (e.key === ' ') { restartGame(); e.preventDefault(); } // Space for restart
    });
    window.addEventListener('keyup', e => {
      const mapKey = {ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right', w:'up', a:'left', s:'down', d:'right'}[e.key];
      if (mapKey) keys[mapKey] = false;
    });

    // Touch buttons (D-pad)
    document.querySelectorAll('#touch-controls .dir').forEach(btn => {
      const dir = btn.dataset.dir;
      btn.addEventListener('touchstart', e => { keys[dir] = true; e.preventDefault(); }, {passive:false});
      btn.addEventListener('touchend', e => { keys[dir] = false; e.preventDefault(); }, {passive:false});
      btn.addEventListener('mousedown', e => { keys[dir] = true; e.preventDefault(); });
      btn.addEventListener('mouseup', e => { keys[dir] = false; e.preventDefault(); });
    });

    // Full controls actions
    document.getElementById('l-btn').addEventListener('click', () => keys.left = true, setTimeout(() => keys.left = false, 100));
    document.getElementById('r-btn').addEventListener('click', () => keys.right = true, setTimeout(() => keys.right = false, 100));
    document.getElementById('a-btn').addEventListener('click', restartGame);
    document.getElementById('b-btn').addEventListener('click', () => gameRunning = !gameRunning); // Pause/unpause

    // Toggle full controls
    document.getElementById('toggle-controls').addEventListener('click', () => {
      const full = document.getElementById('full-controls');
      full.style.display = full.style.display === 'none' ? 'flex' : 'none';
    });

    // Simple swipe (improved threshold for mobile)
    (function addSwipe(el = document.body) {
      let sx=0, sy=0, threshold=30; // Slightly higher for accuracy
      el.addEventListener('touchstart', e => { const t = e.changedTouches[0]; sx = t.clientX; sy = t.clientY; }, {passive:true});
      el.addEventListener('touchend', e => {
        const t = e.changedTouches[0]; const dx = t.clientX - sx; const dy = t.clientY - sy;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
          keys.left = dx < 0; keys.right = dx > 0;
          setTimeout(()=>{ keys.left = keys.right = false; }, 150);
        } else if (Math.abs(dy) > threshold) {
          keys.up = dy < 0; keys.down = dy > 0;
          setTimeout(()=>{ keys.up = keys.down = false; }, 150);
        }
      }, {passive:true});
    })();

    // Utils (tileAt, collides) - same as before
    function tileAt(c, r) {
      if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return 1;
      return map[r][c];
    }

    function collides(x, y, r) {
      const left = Math.floor((x - r) / TILE);
      const right = Math.floor((x + r) / TILE);
      const top = Math.floor((y - r) / TILE);
      const bottom = Math.floor((y + r) / TILE);
      for (let rr = top; rr <= bottom; rr++) {
        for (let cc = left; cc <= right; cc++) {
          if (tileAt(cc, rr) === 1) return true;
        }
      }
      return false;
    }

    // Game loop
    let last = performance.now();
    function step(now) {
      if (!gameRunning) return;
      const dt = Math.min(0.05, (now - last) / 1000);
      last = now;
      update(dt);
      render();
      requestAnimationFrame(step);
    }

    // Update (added scoring)
    function update(dt) {
      const desire = keys.up ? 'up' : keys.down ? 'down' : keys.left ? 'left' : keys.right ? 'right' : null;
      if (desire) player.nextDir = desire;

      if (player.nextDir) {
        const dir = player.nextDir;
        const vx = dir === 'left' ? -1 : dir === 'right' ? 1 : 0;
        const vy = dir === 'up' ? -1 : dir === 'down' ? 1 : 0;
        const nx = player.x + vx * player.speed * dt;
        const ny = player.y + vy * player.speed * dt;
        if (!collides(nx, ny, player.radius - 1)) {
          player.dir = player.nextDir;
          player.nextDir = null;
        }
      }

      if (player.dir) {
        const vx = player.dir === 'left' ? -1 : player.dir === 'right' ? 1 : 0;
        const vy = player.dir === 'up' ? -1 : player.dir === 'down' ? 1 : 0;
        const nx = player.x + vx * player.speed * dt;
        const ny = player.y + vy * player.speed * dt;
        if (!collides(nx, ny, player.radius - 1)) {
          player.x = nx; player.y = ny;
        } else {
          player.dir = null;
        }
      }

      // Eat pellets & score
      const col = Math.floor(player.x / TILE);
      const row = Math.floor(player.y / TILE);
      if (map[row] && map[row][col] === 2) {
        map[row][col] = 0;
        score += 10;
      }
    }

    // Render (added score display)
    function render() {
      ctx.clearRect(0, 0, VIRTUAL_W, VIRTUAL_H);

      ctx.fillStyle = '#05102b';
      ctx.fillRect(0, 0, VIRTUAL_W, VIRTUAL_H);

      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const t = map[r][c];
          const x = c * TILE, y = r * TILE;
          if (t === 1) {
            ctx.fillStyle = '#003b66';
            roundRect(ctx, x + 1, y + 1, TILE - 2, TILE - 2, 3);
            ctx.fill();
          } else if (t === 2) {
            ctx.fillStyle = '#ffd966';
            const cx = x + TILE / 2, cy = y + TILE / 2;
            ctx.beginPath();
            ctx.arc(cx, cy, Math.max(1, TILE * 0.12), 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }

      // Player
      ctx.save();
      ctx.translate(player.x, player.y);
      ctx.fillStyle = '#ffcc00';
      const t = performance.now() / 200;
      const mouth = Math.abs(Math.sin(t)) * 0.3 + 0.05;
      let ang = 0;
      if (player.dir === 'left') ang = Math.PI;
      else if (player.dir === 'up') ang = -Math.PI / 2;
      else if (player.dir === 'down') ang = Math.PI / 2;
      const start = mouth * Math.PI + ang;
      const end = (2 - mouth) * Math.PI + ang;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, player.radius, start, end, false);
      ctx.closePath();
      ctx.fill();
      ctx.restore();

      // Score overlay on canvas
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'left';
      ctx.fillText(`Score: ${score}`, 10, 25);
    }

    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function restartGame() {
      player.x = TILE * 1.5; player.y = TILE * 1.5; player.dir = null; player.nextDir = null;
      score = 0;
      // Reset pellets (simple regen)
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (map[r][c] !== 1) map[r][c] = 2;
        }
      }
      document.getElementById('status').textContent = `Restarted! Score: ${score}`;
    }

    // Start button
    document.getElementById('start-btn').addEventListener('click', () => {
      gameRunning = true;
      last = performance.now();
      requestAnimationFrame(step);
      document.getElementById('status').textContent = 'Playing! Eat pellets for score.';
      document.getElementById('start-btn').style.display = 'none';
      document.getElementById('toggle-controls').style.display = 'block';
    });

    // Auto-setup
    window.addEventListener('load', () => {
      resizeCanvas();
      document.getElementById('status').textContent = 'Tap Start to play! Controls fit better now.';
    });
  </script>
</body>
</html>
